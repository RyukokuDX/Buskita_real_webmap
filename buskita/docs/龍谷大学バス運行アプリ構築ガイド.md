# é¾è°·å¤§å­¦ãƒã‚¹é‹è¡Œã‚¢ãƒ—ãƒªæ§‹ç¯‰ã‚¬ã‚¤ãƒ‰

é¾è°·å¤§å­¦ã®å­¦ç”Ÿå‘ã‘ã«ã€**ãƒã‚¹ã®é…å»¶çŠ¶æ³**ã¨**ç™ºè»Šã¾ã§ã®æ®‹ã‚Šæ™‚é–“**ã‚’ç¢ºèªã§ãã‚‹ã‚¢ãƒ—ãƒªã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã®å°‚ç”¨ã‚¬ã‚¤ãƒ‰ã§ã™ã€‚

## ğŸ“‹ ç›®æ¬¡

1. [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦](#ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦)
2. [é¾è°·å¤§å­¦ãƒã‚¹è·¯ç·šã®åˆ†æ](#é¾è°·å¤§å­¦ãƒã‚¹è·¯ç·šã®åˆ†æ)
3. [åŸºæœ¬æ©Ÿèƒ½ã®å®Ÿè£…](#åŸºæœ¬æ©Ÿèƒ½ã®å®Ÿè£…)
4. [é…å»¶æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ ](#é…å»¶æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ )
5. [ç™ºè»Šæ™‚åˆ»äºˆæ¸¬](#ç™ºè»Šæ™‚åˆ»äºˆæ¸¬)
6. [å­¦ç”Ÿå‘ã‘UIè¨­è¨ˆ](#å­¦ç”Ÿå‘ã‘uiè¨­è¨ˆ)
7. [é€šçŸ¥æ©Ÿèƒ½](#é€šçŸ¥æ©Ÿèƒ½)
8. [ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ](#ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ)

## ğŸ¯ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

### å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼
- é¾è°·å¤§å­¦ã®å­¦ç”Ÿï¼ˆæ·±è‰ãƒ»ç€¬ç”°ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ï¼‰
- æ•™è·å“¡
- å¤§å­¦é–¢ä¿‚è€…

### ä¸»è¦æ©Ÿèƒ½
1. **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é…å»¶ç¢ºèª** - äºˆå®šæ™‚åˆ»ã¨ã®æ¯”è¼ƒ
2. **ç™ºè»Šã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³** - ãƒã‚¹åœã§ã®å¾…æ©Ÿæ™‚é–“è¡¨ç¤º
3. **ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥** - é…å»¶ãƒ»ç™ºè»Šã‚¢ãƒ©ãƒ¼ãƒˆ
4. **è·¯ç·šåˆ¥è¡¨ç¤º** - ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹é–“ã€æœ€å¯„ã‚Šé§…ã‹ã‚‰ã®è·¯ç·š
5. **å±¥æ­´åˆ†æ** - é…å»¶ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å­¦ç¿’

## ğŸšŒ é¾è°·å¤§å­¦ãƒã‚¹è·¯ç·šã®åˆ†æ

### ä¸»è¦è·¯ç·šï¼ˆæ»‹è³€å¸ç”£ãƒã‚¹ï¼‰

```python
# ryukoku_bus_routes.py
RYUKOKU_BUS_ROUTES = {
    "ç€¬ç”°é§…-é¾è°·å¤§å­¦": {
        "route_id": "seta_ryukoku",
        "stops": [
            {"name": "ç€¬ç”°é§…", "lat": 34.9667, "lng": 135.9167},
            {"name": "é¾è°·å¤§å­¦å‰", "lat": 34.9456, "lng": 135.9123},
            {"name": "é¾è°·å¤§å­¦", "lat": 34.9445, "lng": 135.9134}
        ],
        "schedule": {
            "å¹³æ—¥": ["7:30", "8:00", "8:30", "9:00", "16:30", "17:00", "17:30"],
            "åœŸæ›œ": ["8:00", "9:00", "16:00", "17:00"],
            "æ—¥ç¥": []
        }
    },
    "çŸ³å±±é§…-é¾è°·å¤§å­¦": {
        "route_id": "ishiyama_ryukoku", 
        "stops": [
            {"name": "çŸ³å±±é§…", "lat": 34.9667, "lng": 135.9000},
            {"name": "é¾è°·å¤§å­¦", "lat": 34.9445, "lng": 135.9134}
        ],
        "schedule": {
            "å¹³æ—¥": ["7:45", "8:15", "8:45", "16:45", "17:15", "17:45"],
            "åœŸæ›œ": ["8:15", "16:45"],
            "æ—¥ç¥": []
        }
    }
}
```

### ãƒã‚¹åœåº§æ¨™ã®ç‰¹å®š

```python
# bus_stop_locator.py
import requests
from datetime import datetime

class RyukokuBusStopLocator:
    def __init__(self):
        self.api_base = "https://api.buskita.com"
        self.site_id = 9  # æ»‹è³€å¸ç”£ãƒã‚¹
        
    def get_landmarks_near_university(self):
        """é¾è°·å¤§å­¦å‘¨è¾ºã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‚’å–å¾—"""
        url = f"{self.api_base}/get-landmarks-dictionary"
        params = {'language': 1, 'siteId': self.site_id}
        
        response = requests.get(url, params=params)
        landmarks = response.json()
        
        # é¾è°·å¤§å­¦é–¢é€£ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‚’æŠ½å‡º
        ryukoku_landmarks = []
        for landmark in landmarks:
            if "é¾è°·" in landmark.get('name', '') or "ç€¬ç”°" in landmark.get('name', ''):
                ryukoku_landmarks.append(landmark)
                
        return ryukoku_landmarks
    
    def find_buses_near_campus(self, campus_lat=34.9445, campus_lng=135.9134, radius=0.01):
        """ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹å‘¨è¾ºã®ãƒã‚¹ã‚’æ¤œç´¢"""
        url = f"{self.api_base}/get-buses"
        params = {'language': 1, 'siteId': self.site_id}
        
        response = requests.get(url, params=params)
        buses = response.json()
        
        nearby_buses = []
        for bus in buses:
            lat_diff = abs(bus['lat'] - campus_lat)
            lng_diff = abs(bus['lng'] - campus_lng)
            
            if lat_diff <= radius and lng_diff <= radius:
                nearby_buses.append(bus)
                
        return nearby_buses
```

## ğŸ—ï¸ åŸºæœ¬æ©Ÿèƒ½ã®å®Ÿè£…

### ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

```python
# ryukoku_bus_app.py
import requests
import sqlite3
from datetime import datetime, timedelta
import json

class RyukokuBusApp:
    def __init__(self):
        self.api_base = "https://api.buskita.com"
        self.site_id = 9
        self.db_path = "ryukoku_bus.db"
        self.init_database()
        
    def init_database(self):
        """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        # ãƒã‚¹ä½ç½®å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS bus_history (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                work_no INTEGER,
                latitude REAL,
                longitude REAL,
                speed REAL,
                update_time TEXT,
                recorded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # é…å»¶è¨˜éŒ²ãƒ†ãƒ¼ãƒ–ãƒ«
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS delay_records (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                route_name TEXT,
                scheduled_time TEXT,
                actual_time TEXT,
                delay_minutes INTEGER,
                date DATE,
                weather TEXT
            )
        ''')
        
        conn.commit()
        conn.close()
    
    def get_current_buses(self):
        """ç¾åœ¨é‹è¡Œä¸­ã®ãƒã‚¹ã‚’å–å¾—"""
        url = f"{self.api_base}/get-buses"
        params = {'language': 1, 'siteId': self.site_id}
        
        try:
            response = requests.get(url, params=params)
            return response.json()
        except Exception as e:
            print(f"ãƒã‚¹æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
            return []
    
    def is_bus_at_campus(self, bus, campus_coords):
        """ãƒã‚¹ãŒã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ä»˜è¿‘ã«ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯"""
        campus_lat, campus_lng = campus_coords
        threshold = 0.002  # ç´„200m
        
        lat_diff = abs(bus['lat'] - campus_lat)
        lng_diff = abs(bus['lng'] - campus_lng)
        
        return lat_diff <= threshold and lng_diff <= threshold
    
    def calculate_delay(self, bus, scheduled_times):
        """é…å»¶æ™‚é–“ã‚’è¨ˆç®—"""
        current_time = datetime.now()
        current_time_str = current_time.strftime("%H:%M")
        
        # æœ€ã‚‚è¿‘ã„äºˆå®šæ™‚åˆ»ã‚’è¦‹ã¤ã‘ã‚‹
        closest_scheduled = None
        min_diff = float('inf')
        
        for scheduled in scheduled_times:
            scheduled_dt = datetime.strptime(scheduled, "%H:%M").replace(
                year=current_time.year,
                month=current_time.month,
                day=current_time.day
            )
            
            diff = abs((current_time - scheduled_dt).total_seconds())
            if diff < min_diff:
                min_diff = diff
                closest_scheduled = scheduled_dt
        
        if closest_scheduled:
            delay_seconds = (current_time - closest_scheduled).total_seconds()
            delay_minutes = int(delay_seconds / 60)
            return delay_minutes
        
        return 0
    
    def estimate_departure_time(self, bus, bus_stop_coords):
        """ç™ºè»Šæ™‚åˆ»ã‚’äºˆæ¸¬"""
        # ãƒã‚¹ãŒãƒã‚¹åœã«åœè»Šã—ã¦ã„ã‚‹å ´åˆã®ç™ºè»Šäºˆæ¸¬
        if self.is_bus_at_campus(bus, bus_stop_coords):
            # åœè»Šæ™‚é–“ã®å±¥æ­´ã‹ã‚‰äºˆæ¸¬ï¼ˆå¹³å‡2-3åˆ†ï¼‰
            base_stop_time = 2  # åŸºæœ¬åœè»Šæ™‚é–“ï¼ˆåˆ†ï¼‰
            
            # é€Ÿåº¦ãŒ0ã®å ´åˆã¯åœè»Šä¸­
            if bus.get('speed', 0) == 0:
                # å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰åœè»Šæ™‚é–“ã‚’äºˆæ¸¬
                estimated_departure = datetime.now() + timedelta(minutes=base_stop_time)
                return estimated_departure
        
        return None
```

## â° é…å»¶æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ 

```python
# delay_detection.py
from datetime import datetime, timedelta
import statistics

class DelayDetectionSystem:
    def __init__(self, db_path="ryukoku_bus.db"):
        self.db_path = db_path
        
    def detect_delay(self, route_name, current_time, scheduled_times):
        """é…å»¶ã‚’æ¤œçŸ¥"""
        current_dt = datetime.strptime(current_time, "%H:%M")
        
        delays = []
        for scheduled in scheduled_times:
            scheduled_dt = datetime.strptime(scheduled, "%H:%M")
            
            # äºˆå®šæ™‚åˆ»ã‹ã‚‰30åˆ†ä»¥å†…ã®ç¯„å›²ã§ç¢ºèª
            time_diff = (current_dt - scheduled_dt).total_seconds() / 60
            
            if 0 <= time_diff <= 30:  # 0-30åˆ†ã®é…å»¶ç¯„å›²
                delays.append({
                    'scheduled': scheduled,
                    'actual': current_time,
                    'delay_minutes': int(time_diff),
                    'status': self.get_delay_status(time_diff)
                })
        
        return delays
    
    def get_delay_status(self, delay_minutes):
        """é…å»¶çŠ¶æ³ã‚’åˆ†é¡"""
        if delay_minutes <= 2:
            return "å®šåˆ»"
        elif delay_minutes <= 5:
            return "è»½å¾®ãªé…å»¶"
        elif delay_minutes <= 10:
            return "é…å»¶"
        else:
            return "å¤§å¹…é…å»¶"
    
    def analyze_delay_patterns(self, route_name, days=30):
        """é…å»¶ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åˆ†æ"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        # éå»30æ—¥ã®é…å»¶ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        cursor.execute('''
            SELECT scheduled_time, delay_minutes, date, weather
            FROM delay_records 
            WHERE route_name = ? AND date >= date('now', '-30 days')
            ORDER BY date DESC
        ''', (route_name,))
        
        records = cursor.fetchall()
        conn.close()
        
        if not records:
            return None
        
        # æ™‚é–“å¸¯åˆ¥é…å»¶åˆ†æ
        time_delays = {}
        for record in records:
            scheduled_time = record[0]
            delay = record[1]
            
            if scheduled_time not in time_delays:
                time_delays[scheduled_time] = []
            time_delays[scheduled_time].append(delay)
        
        # çµ±è¨ˆæƒ…å ±ã‚’è¨ˆç®—
        analysis = {}
        for time_slot, delays in time_delays.items():
            analysis[time_slot] = {
                'average_delay': statistics.mean(delays),
                'max_delay': max(delays),
                'delay_frequency': len([d for d in delays if d > 2]) / len(delays)
            }
        
        return analysis
```

## ğŸ“± å­¦ç”Ÿå‘ã‘UIè¨­è¨ˆ

### Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

```python
# web_app.py
from flask import Flask, render_template, jsonify, request
from datetime import datetime
import json

app = Flask(__name__)
bus_app = RyukokuBusApp()
delay_system = DelayDetectionSystem()

@app.route('/')
def index():
    return render_template('ryukoku_bus.html')

@app.route('/api/campus-buses')
def get_campus_buses():
    """ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹å‘¨è¾ºã®ãƒã‚¹æƒ…å ±"""
    buses = bus_app.get_current_buses()
    
    # é¾è°·å¤§å­¦ã®åº§æ¨™
    campus_coords = (34.9445, 135.9134)
    
    campus_buses = []
    for bus in buses:
        if bus_app.is_bus_at_campus(bus, campus_coords):
            # ç™ºè»Šäºˆå®šæ™‚åˆ»ã‚’è¨ˆç®—
            departure_time = bus_app.estimate_departure_time(bus, campus_coords)
            
            bus_info = {
                'workNo': bus['workNo'],
                'lat': bus['lat'],
                'lng': bus['lng'],
                'speed': bus.get('speed', 0),
                'updateTime': bus['updateTime'],
                'estimatedDeparture': departure_time.strftime("%H:%M") if departure_time else None,
                'minutesUntilDeparture': int((departure_time - datetime.now()).total_seconds() / 60) if departure_time else None
            }
            campus_buses.append(bus_info)
    
    return jsonify(campus_buses)

@app.route('/api/delay-status/<route_name>')
def get_delay_status(route_name):
    """è·¯ç·šã®é…å»¶çŠ¶æ³"""
    current_time = datetime.now().strftime("%H:%M")
    
    # è·¯ç·šã®äºˆå®šæ™‚åˆ»ã‚’å–å¾—
    scheduled_times = RYUKOKU_BUS_ROUTES.get(route_name, {}).get('schedule', {}).get('å¹³æ—¥', [])
    
    delays = delay_system.detect_delay(route_name, current_time, scheduled_times)
    
    return jsonify({
        'route': route_name,
        'current_time': current_time,
        'delays': delays
    })

@app.route('/api/next-buses')
def get_next_buses():
    """æ¬¡ã®ãƒã‚¹ã®æ™‚åˆ»è¡¨"""
    current_time = datetime.now()
    current_hour = current_time.hour
    current_minute = current_time.minute
    
    next_buses = []
    
    for route_name, route_info in RYUKOKU_BUS_ROUTES.items():
        schedule = route_info['schedule']['å¹³æ—¥']
        
        for time_str in schedule:
            bus_hour, bus_minute = map(int, time_str.split(':'))
            
            # ç¾åœ¨æ™‚åˆ»ã‚ˆã‚Šå¾Œã®ãƒã‚¹ã‚’æ¤œç´¢
            if bus_hour > current_hour or (bus_hour == current_hour and bus_minute > current_minute):
                minutes_until = (bus_hour - current_hour) * 60 + (bus_minute - current_minute)
                
                next_buses.append({
                    'route': route_name,
                    'scheduled_time': time_str,
                    'minutes_until': minutes_until
                })
        
        # æ™‚é–“é †ã«ã‚½ãƒ¼ãƒˆ
        next_buses.sort(key=lambda x: x['minutes_until'])
    
    return jsonify(next_buses[:5])  # æ¬¡ã®5æœ¬ã‚’è¿”ã™

if __name__ == '__main__':
    app.run(debug=True)
```

## ğŸ¯ ä½¿ç”¨æ–¹æ³•

### é–‹ç™ºç’°å¢ƒã§ã®å®Ÿè¡Œ

```bash
# ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip install -r requirements.txt

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–
python -c "from ryukoku_bus_app import RyukokuBusApp; RyukokuBusApp()"

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•
python web_app.py
```

### å­¦ç”Ÿå‘ã‘æ©Ÿèƒ½

1. **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç¢ºèª**: http://localhost:5000
2. **é…å»¶é€šçŸ¥ç™»éŒ²**: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç™»éŒ²ã§è‡ªå‹•é€šçŸ¥
3. **æ™‚åˆ»è¡¨ç¢ºèª**: æ¬¡ã®ãƒã‚¹ã®ç™ºè»Šæ™‚åˆ»
4. **ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹å†…ãƒã‚¹**: ç¾åœ¨ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ã«ã„ã‚‹ãƒã‚¹

## ğŸ“Š ä»Šå¾Œã®æ‹¡å¼µæ¡ˆ

- **æ··é›‘åº¦äºˆæ¸¬**: ä¹—è»Šäººæ•°ã®æ¨å®š
- **å¤©å€™é€£æº**: å¤©æ°—ã«ã‚ˆã‚‹é…å»¶äºˆæ¸¬
- **å­¦äº‹æ—¥ç¨‹é€£æº**: è©¦é¨“æœŸé–“ãƒ»ä¼‘è¬›æƒ…å ±ã¨ã®é€£å‹•
- **ä»–å¤§å­¦å¯¾å¿œ**: åŒå¿—ç¤¾å¤§å­¦ã€ç«‹å‘½é¤¨å¤§å­¦ã¸ã®å±•é–‹

---

**é¾è°·å¤§å­¦ã®å­¦ç”Ÿç”Ÿæ´»ã‚’ã‚ˆã‚Šä¾¿åˆ©ã«ï¼ğŸ“ğŸšŒ** 