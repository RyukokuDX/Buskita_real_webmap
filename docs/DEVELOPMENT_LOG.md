# 開発ログ

---

## 2025/06/27: プロジェクト始動＆リアルタイムマップ実装

### v0.1: リアルタイムバスマップの実現

#### 目的
- `RyukokuDX/buskita`リポジトリを基に、バスの位置をリアルタイムで表示するWebアプリケーションを開発する。

#### 調査フェーズ
- **APIの特定:**
  - リポジトリ内の全スクリプトを調査。
  - `scripts/bus_id_explorer.py` を実行した結果、**`get-buses` API** が、運行中の全バス情報を取得するための有効なエンドポイントであると特定。これを開発の技術的根幹とする。

#### 実装フェーズ
- **バックエンド (`web_map_app.py`):**
  - Webフレームワークとして **Flask** を採用。
  - `/api/bus_locations` というAPIエンドポイントを設置。3秒ごとに`get-buses` API (`siteId=9`)を呼び出し、結果をJSON形式で提供する。
- **フロントエンド (`templates/index.html`):**
  - 地図ライブラリとして **Leaflet.js** を採用。
  - 3秒ごとにバックエンドAPIにアクセスし、取得したバスの位置情報を地図上のマーカーとして描画する。

#### 課題と解決の道のり
1.  **問題:** APIの応答が不安定で、バス情報が「0台」と返されることが頻発した。
    - **対策:** 正常に取得できた最新のバス情報を`last_known_buses.json`に保存する**バックアップ機能**と、API不調時にそれを読み込む**フォールバック機能**を実装。システムの安定性を向上させた。

2.  **問題:** バックエンド・フロントエンド共にプログラムは正常に動作しているように見えるが、バスが地図に表示されない、という深刻な問題に直面。
    - **原因特定:** 長時間にわたるデバッグの末、「原点回帰テスト」（機能を最小単位にしてテストすること）を実施。その結果、**フロントエンドのカスタムアイコン描画処理に、稀なライブラリの内部的な不具合が潜んでいること**を特定した。
    - **最終解決:** 問題の根本原因となっていたカスタムアイコン機能を完全に撤廃。Leaflet標準のマーカーを利用する、最もシンプルで堅牢な方法に切り替えることで、最終的に安定した描画に成功した。

#### 到達点
- 「更新のたびに画面が引き戻される」というUXの問題を、初回のみ地図範囲を自動調整するように修正し、解決。
- APIの不安定性を乗り越え、滋賀エリアのバス位置を3秒間隔でリアルタイム表示する、アプリケーションの根幹機能（MVP）を完成させた。

### v0.2: 詳細情報表示機能の追加

- **目的:** アプリの付加価値を高めるため、バスの「遅延情報」と「乗客数」を表示する機能を追加する。
- **実装:**
  - **バックエンドの機能拡張:**
    - `get-bus` APIを並行処理で呼び出し、各バスの詳細情報を取得するロジックを追加。
    - `ThreadPoolExecutor` を活用し、多数のAPIを呼び出す際のパフォーマンス低下を抑制。
    - `/api/bus_locations` が返す情報に、`delayMinutes` と `passenger` を追加。
  - **フロントエンドの機能追加:**
    - バスマーカーのポップアップに、「遅延情報」と「乗客数」を表示するように修正。
    - `passenger` (乗客数) の値に応じて、バスアイコンの色がリアルタイムで変化する（青・緑・黄・赤など）機能を実装し、混雑度を直感的に把握できるようにした。

### v0.3: UI/UXの改善

- **目的:** 大学生が毎日使いたくなるような、洗練された、心地よいデザインにアプリを進化させる。
- **実装:**
  - **マップデザインの変更:**
    - 背景地図を、当初の標準的なものから、モダンなダークモード (`CartoDB.DarkMatter`) へと変更。
    - ユーザーからのフィードバックに基づき、最終的に、より可読性が高く、クリーンな白地図 (`Stadia.AlidadeSmooth`) にデザインを決定。
  - **アイコンとポップアップの改善:**
    - バスアイコンを、Font Awesomeを利用した、よりスタイリッシュなデザインに変更。
    - ポップアップのデザインを、地図のテーマに合わせて、縦長で見やすいレイアウトに調整。
    - アイコンカラーの定義を、ユーザーの体感に合わせて、より具体的で分かりやすい基準（5段階の色分け）に決定。

### v1.0: 完成 (2025/06/27)

- **最終確認:**
  - 全ての必須機能(F-01, F-02, F-03)及び、発展機能(F-04, F-05)が、要件定義書通りに動作することを、最終確認済み。
  - UI/UXの改善サイクルを一周し、学生が日常的に利用する上で、十分な品質を確保。
- **到達点:**
  - これをもって、「Ryukoku Bus Navi」のバージョン1.0を、正式に**完成**とする。
- **今後の展望:**
  - `REQUIREMENTS.md`に記載された、未実装の発展機能（時刻表、通知機能など）。
  - `UI_UX_IMPROVEMENTS.md`に記載された、さらなる操作性向上（ローディング、ホバーアニメーションなど）。

### v1.1: UXの最終調整

- **目的:** v1.0の完成度を、さらに高めるための微調整を実施。
- **実装:**
  - **ルート表示機能の検討:**
    - 道路に沿ったルートを描画する機能(`leaflet-routing-machine`を利用)を試験的に実装。
    - しかし、APIから安定したルート情報を取得することが困難であると判明したため、アプリ全体の安定性を最優先し、この機能の導入は一旦見送るという、戦略的判断を下した。
  - **初期表示の最適化:**
    - アプリ起動時の地図の初期表示位置とズームレベルを、ユーザーの視点に基づき、「龍谷大学瀬田キャンパスが最も分かりやすく見えるビュー」に最終調整した。

### v1.2 (Pre-release): ダッシュボード機能の再実装

- **目的:** アプリのUI/UXをさらに向上させるため、時刻表などの情報を集約表示する「ダッシュボード」機能の開発に再挑戦した。
- **実装と課題:**
  - 画面を2カラムに分割し、右側にサイドパネルを配置する、新しいレイアウトの骨格を構築。
  - 凡例を地図上からサイドパネル内に移動させ、さらに時刻表機能を統合する、という複雑な実装に一度挑戦。
  - しかし、結果としてUIが複雑化し、「ごちゃごちゃしている」とのフィードバックをいただいた。
- **結論と到達点:**
  - ユーザーからのフィードバックに基づき、一旦、全ての変更を差し戻し、v1.1のシンプルで完成度の高い状態に復帰。
  - その後、改めて、より慎重なステップで、**「地図」+「凡例」**と**「時刻表リンク付きダッシュボード」**が共存する、新しいレイアウトを再構築し、その状態をv1.2の到達点とした。

### v1.3: ダッシュボードの高機能化

- **目的:** ユーザー体験を向上させるため、ローディングアニメーションと、より詳細なリアルタイム情報（次のバス2本分のカウントダウン）をダッシュボードに実装する。
- **実装:**
  - **ローディング画面:**
    - 初回データ読み込み中に、スピナー付きのオーバーレイを表示する機能を実装。これにより、ユーザーはアプリが動作中であることを視覚的に認識でき、待ち時間のストレスが軽減される。
  - **カウントダウン機能の拡張:**
    - ダッシュボードに「瀬田駅 ⇔ 龍谷大学」両方向のカウントダウンを表示。
    - さらに、それぞれの方向で「次のバス」と「その次のバス」の2本先までの発車時刻と、そこまでの残り時間をリアルタイムで表示するように機能を拡張。
    - CSSを調整し、情報が整理され、時間表示が揃うようにレイアウトを改善。
  - **最終バス情報の改善:**
    - 表示レイアウトを改行を用いて見やすく修正。
    - 時刻表データを拡充し、土曜・日祝のデータにも対応。

### v1.4: 時刻表データ基盤の確立と正常化

- **目的:** アプリの根幹である時刻表機能について、その情報源を確定し、信頼性を確立する。
- **経緯と課題:**
  - 当初、AIアシスタントの事実誤認（ハルシネーション）により、「公式の時刻表APIが存在する」という誤った前提で開発を進めてしまい、深刻な手戻りと時間の浪費が発生した。
  - その後、スクレイピングによる情報取得も、公式サイトの強固な対策により失敗に終わる。
- **最終解決策:**
  - **原点回帰:** 唯一信頼できる情報源は、プロジェクト内に存在する静的ファイル`buskita/static/timetable.json`であると再確認。
  - **船長による情報収集:** 船長自ら、公式サイトの正確な時刻表情報をスクリーンショットで収集。
  - **データの手動更新:** 提供された正確な情報に基づき、`timetable.json`を「直行」と「各停」に分類し、全ての曜日についてデータを完全に更新。
- **到達点:**
  - これまで曖昧だった時刻表のデータ基盤を、**`timetable.json`を唯一の正とする**形で完全に確立。
  - ダッシュボードは、この正確なデータに基づき、全ての方向・分類のバスについて、安定してカウントダウンを表示できるようになった。
  - AIアシスタントは、事実確認の重要性を再認識し、`DEVELOPMENT_RULES.md`の厳守を改めて誓った。

### v1.5: 時刻表の視認性向上

- **目的:** 複数のカードに分散していた時刻表を、より直感的で比較しやすいレイアウトに改善する。
- **実装:**
  1.  **データ構造の統合:**
      - それまで「各停」「直行」で分離されていた`timetable.json`の構造を、方向別の`seta_to_univ`, `univ_to_seta`に統合。各時刻に`is_direct`フラグを持たせる、より拡張性の高い形式に刷新した。
  2.  **サーバー処理の適応:**
      - 新しいJSON形式に対応するため、`web_map_app.py`の`group_schedules_by_hour`関数を改修。直行便に`(直)`という目印を付与するロジックを実装した。
  3.  **表示レイアウトの刷新:**
      - `timetable.html`を、従来のグリッドレイアウトから、時間帯ごとに行が分かれる伝統的なテーブル形式(`<table>`)に全面的に書き換え。CSSも併せて修正し、視認性を大幅に向上させた。

### v1.6: ダッシュボード機能の全面改修

- **目的:**
  - 時刻表のデータ構造変更に伴い、ダッシュボードのカウントダウン機能を新しいデータ形式に完全対応させる。
  - ユーザーからのフィードバックに基づき、より正確で、より洗練された表示に改善する。
- **実装:**
  1.  **APIの追加:** ダッシュボードが時刻表データを非同期に取得できるよう、`/api/timetable_data`という新しいAPIエンドポイントを`web_map_app.py`に設置した。
  2.  **表示ロジックの刷新:**
      - `index.html`のJavaScriptを全面的に書き換え。「約X分後」という曖昧な表現を廃止し、「X分後」という正確な表示に変更。
      - `setInterval`の実行間隔を調整し、よりリアルタイム性の高いカウントダウンを実現。
  3.  **デザインの統一:**
      - `style.css`を修正し、ダッシュボード全体のフォントサイズやスタイルを、ヘッダーの行き先表示と統一感のある、より洗練されたデザインに調整した。

### インシデント対応の記録: 行き先「N/A」問題
- **事象:** 上記の改修過程で、バスアイコンのポップアップに表示されるべき行き先情報が「N/A」となる、深刻なデグレード（機能後退）が発生した。
- **原因:** 私（AIアシスタント）が`web_map_app.py`を修正する過程で、バスの詳細情報（行き先、遅延、乗客数）を取得するための重要な処理 (`get_bus_details`関数と、それを呼び出す並列処理部分) を、誤って削除してしまっていたことが原因。APIのデータ構造に関する私の**思い込み**と、変更が全体に及ぼす影響を軽視した**部分最適化**が、根本的な問題であった。
- **解決:**
  1.  **デバッグの実施:** `web_map_app.py`に一時的なprint文を挿入し、APIから返される生のデータ構造を「事実」として確認。これにより、行き先情報が`destination`キーではなく`routeNames['1']`に含まれていることを特定した。
  2.  **処理の復元と修正:** 誤って削除した詳細情報取得の処理を完全に復元。行き先情報の参照先を、事実に基づき`routeNames['1']`に修正することで、問題を完全に解決した。
- **教訓:** この一連の失敗は`docs/ASSISTANT_SELF_ANALYSIS.md`に記録し、今後の開発における戒めとする。

### v1.7: 乗客数表示の不具合修正と環境復元

- **目的:**
  - フロントエンドで乗客数が常に「0人」と表示される不具合を修正する。
  - プロジェクトの構成を、ファイル整理前のシンプルな状態（v1.6直後）へと復元する。
- **インシデント対応:**
  1.  **問題の切り分け:** フロントエンドのコード(`index.html`)を確認し、乗客数データのキー参照に誤りがないかを検証。前回の修正でキーは`passenger`に統一されており、フロントエンド側に問題がないことを確認。
  2.  **原因の特定:** バックエンドのコード(`web_map_app.py`)にデバッグ用のprint文を挿入し、外部APIから返却される生のバスデータをコンソールに出力。これにより、これまで`passengerCount`というキーで取得できると**思い込んでいた**乗客数データが、実際には`passenger`というキーで提供されているという「事実」を特定した。
  3.  **解決:** `filter_and_format_buses`関数内のキー参照を、`passengerCount`から、事実に即した`passenger`へと修正。これにより、乗客数が正しく表示されるようになった。
- **環境復元:**
  - 船長からの指示に基づき、ファイル整理のために作成した`backend`ディレクトリを廃止。全てのファイルを`buskita`ディレクトリ直下に戻し、v1.6バックアップ直後のシンプルな構成に復元した。
- **到達点:**
  - 乗客数表示機能が完全に正常化。
  - プロジェクトのファイル構造が、当初の分かりやすい状態に復旧。
  - これをもって、v1.7の状態をバックアップとして保存。

---
*このログは、次なる航海が始まるその日まで、一旦筆を置く。* 